# ---- EstÃ¡gio 1: Build ----
FROM node:20-alpine AS build
WORKDIR /app

# Copia dependÃªncias e instala
COPY package*.json ./
RUN npm install

# Copia cÃ³digo-fonte e schema do Prisma
COPY . .

# Gera Prisma Client no estÃ¡gio de build
ARG DATABASE_URL
ENV DATABASE_URL=$DATABASE_URL
RUN npx prisma generate

# ---- EstÃ¡gio 2: ProduÃ§Ã£o ----
FROM node:20-alpine
WORKDIR /app

# Copia tudo, inclusive node_modules e schema.prisma
COPY --from=build /app . 

# Instala apenas dependÃªncias de produÃ§Ã£o
RUN npm ci --omit=dev

# ðŸš€ Garante que Prisma Client serÃ¡ gerado no runtime se necessÃ¡rio
RUN echo '#!/bin/sh\nnpx prisma generate --schema=./prisma/schema.prisma && node src/server.js' > /start.sh \
    && chmod +x /start.sh

EXPOSE 3001
CMD ["/bin/sh", "/start.sh"]
