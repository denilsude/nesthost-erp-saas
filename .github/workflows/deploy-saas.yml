name: Deploy SaaS (api, app)

on:
  push:
    branches:
      - main # Dispara toda vez que houver um push na 'main'
    paths:
      # Só dispara se houver mudanças no backend, frontend ou nos scripts
      - 'backend/**'
      - 'frontend/**'
      - 'docker-compose.yml'
      - '.github/workflows/deploy-saas.yml' # <-- Corrigido para o nome do seu arquivo

jobs:
  deploy:
    runs-on: [self-hosted, pentecost] # Roda no nosso runner 'pentecost'

    steps:
      - name: 1. Baixar o código (Checkout)
        # Este checkout é apenas para o runner "saber" que o job existe
        uses: actions/checkout@v4

      - name: 2. Deploy no Servidor (Git Pull e Docker Compose)
        # Este é o script de deploy CORRETO
        run: |
          echo "1. Acessando o diretório de produção..."
          cd ~/nesthost-erp-saas
          
          echo "2. Puxando o código mais recente do GitHub..."
          git pull origin main
          
          echo "3. Reconstruindo e reiniciando os containers (lendo o .env da raiz)..."
          # O '--build' só reconstrói o que mudou
          # O '-d' (detached) roda em segundo plano
          docker compose up -d --build
          
          echo "4. Limpando imagens Docker antigas..."
          docker image prune -f